;; ==============================================================================
;; SEMANTIC INDEX - JavaScript/TypeScript
;; ==============================================================================
;; Captures all semantic information needed to build a complete symbol table
;; with proper lexical scoping. The processor uses position containment to
;; determine scope hierarchy.
;;
;; Capture naming convention:
;;   @scope.[type] - Scope boundaries
;;   @def.[kind].[detail] - Symbol definitions
;;   @ref.[kind] - Symbol references
;;   @import.[type] - Import statements
;;   @export.[type] - Export statements
;;   @type.[kind] - Type annotations (TypeScript)
;; ==============================================================================

;; ==============================================================================
;; SCOPES - Define lexical boundaries
;; ==============================================================================

; Root scope
(program) @scope.module

; Function scopes
(function_declaration) @scope.function
(function_expression) @scope.function
(arrow_function) @scope.function
(method_definition) @scope.method
(generator_function_declaration) @scope.function
(generator_function) @scope.function

; Class scopes
(class_declaration) @scope.class
(class) @scope.class

; Block scopes (ES6 let/const scoping)
(statement_block) @scope.block
(for_statement) @scope.block
(for_in_statement) @scope.block
(while_statement) @scope.block
(do_statement) @scope.block
(if_statement) @scope.block
(switch_statement) @scope.block
(switch_case) @scope.block
(try_statement) @scope.block
(catch_clause) @scope.block
(finally_clause) @scope.block

;; ==============================================================================
;; DEFINITIONS - Symbols that introduce new names
;; ==============================================================================

; Function definitions (hoisted to containing function/module scope)
(function_declaration
  name: (identifier) @def.function.name
  parameters: (formal_parameters) @def.function.params
) @def.function

; Function expressions (only hoisted if named)
(function_expression
  name: (identifier)? @def.function.name
  parameters: (formal_parameters) @def.function.params
) @def.function.expr

; Arrow functions (never hoisted, may be assigned)
(arrow_function
  parameters: [
    (identifier) @def.param
    (formal_parameters) @def.function.params
  ]
) @def.arrow

; Variable declarations
(variable_declaration
  (variable_declarator
    name: [
      (identifier) @def.var
      (array_pattern) @def.var.destructured
      (object_pattern) @def.var.destructured
    ]
    value: (_)? @def.var.init
  )
) @def.var.statement

; Lexical declarations (const/let - block scoped)
(lexical_declaration
  kind: "const"
  (variable_declarator
    name: [
      (identifier) @def.const
      (array_pattern) @def.const.destructured
      (object_pattern) @def.const.destructured
    ]
    value: (_)? @def.const.init
  )
) @def.const.statement

(lexical_declaration
  kind: "let"
  (variable_declarator
    name: [
      (identifier) @def.let
      (array_pattern) @def.let.destructured
      (object_pattern) @def.let.destructured
    ]
    value: (_)? @def.let.init
  )
) @def.let.statement

; Class definitions
(class_declaration
  name: (identifier) @def.class.name
  (class_heritage)? @def.class.extends
  (class_body) @def.class.body
) @def.class

(class
  name: (identifier)? @def.class.name
  (class_heritage)? @def.class.extends
  (class_body) @def.class.body
) @def.class.expr

; Method definitions (inside classes)
(method_definition
  name: (property_identifier) @def.method.name
  parameters: (formal_parameters) @def.method.params
) @def.method

(method_definition
  name: (private_property_identifier) @def.method.private
  parameters: (formal_parameters) @def.method.params
) @def.method.private

; Class fields
(field_definition
  property: [
    (property_identifier) @def.field.name
    (private_property_identifier) @def.field.private
  ]
) @def.field

; Parameter definitions
(formal_parameters
  [
    (identifier) @def.param
    (rest_pattern (identifier) @def.param.rest)
    (assignment_pattern
      left: (identifier) @def.param
      right: (_) @def.param.default
    )
  ]
)

; Destructuring patterns in parameters
(formal_parameters
  (object_pattern
    (shorthand_property_identifier_pattern) @def.param.destructured
    (pair_pattern
      key: (property_identifier)
      value: (identifier) @def.param.destructured
    )
  )
)

(formal_parameters
  (array_pattern
    (identifier) @def.param.destructured
  )
)

; Catch clause parameter
(catch_clause
  parameter: (identifier)? @def.catch_param
)

; Loop variables
(for_in_statement
  left: [
    (identifier) @def.loop_var
    (variable_declaration (variable_declarator name: (identifier) @def.loop_var))
    (lexical_declaration (variable_declarator name: (identifier) @def.loop_var))
  ]
)

; Note: for...of loops are parsed as for_in_statement in tree-sitter-javascript

; Label definitions
(labeled_statement
  label: (statement_identifier) @def.label
)

;; ==============================================================================
;; IMPORTS - External symbol introduction
;; ==============================================================================

(import_statement
  source: (string) @import.source
) @import

; Default import
(import_clause
  (identifier) @import.default
)

; Named imports
(import_clause
  (named_imports
    (import_specifier
      name: (identifier) @import.named.source
      alias: (identifier)? @import.named.local
    )
  )
)

; Namespace import
(import_clause
  (namespace_import (identifier) @import.namespace)
)

; CommonJS require (pattern matching)
(variable_declarator
  name: (identifier) @import.commonjs
  value: (call_expression
    function: (identifier) @_require
    arguments: (arguments (string) @import.commonjs.source)
  )
  (#eq? @_require "require")
) @import.commonjs.statement

; Dynamic import()
(call_expression
  function: (import) @import.dynamic
  arguments: (arguments (string) @import.dynamic.source)
) @import.dynamic.expr

;; ==============================================================================
;; EXPORTS - Module boundary symbols
;; ==============================================================================

; Named exports
(export_statement
  (export_clause
    (export_specifier
      name: (identifier) @export.named.local
      alias: (identifier)? @export.named.exported
    )
  )
) @export.named

; Default export
(export_statement
  "default"
  value: [
    (identifier) @export.default.ref
    (function_declaration name: (identifier) @export.default.function)
    (class_declaration name: (identifier) @export.default.class)
    (_) @export.default.expr
  ]
) @export.default

; Export declaration
(export_statement
  declaration: [
    (function_declaration name: (identifier) @export.decl.function)
    (class_declaration name: (identifier) @export.decl.class)
    (lexical_declaration) @export.decl.variable
    (variable_declaration) @export.decl.variable
  ]
) @export.declaration

; Re-exports
(export_statement
  source: (string) @export.reexport.source
) @export.reexport

; CommonJS exports
(assignment_expression
  left: (member_expression
    object: (identifier) @_module
    property: (property_identifier) @_exports
  )
  right: (_) @export.commonjs.value
  (#eq? @_module "module")
  (#eq? @_exports "exports")
) @export.commonjs

(assignment_expression
  left: (member_expression
    object: (identifier) @_exports
    property: (property_identifier) @export.commonjs.name
  )
  right: (_) @export.commonjs.value
  (#eq? @_exports "exports")
) @export.commonjs.property

;; ==============================================================================
;; REFERENCES - Symbol usage (need scope resolution)
;; ==============================================================================

; Function calls
(call_expression
  function: (identifier) @ref.call.function
  arguments: (arguments) @ref.call.args
)

; Method calls
(call_expression
  function: (member_expression
    object: (_) @ref.call.object
    property: (property_identifier) @ref.call.method
  )
  arguments: (arguments) @ref.call.args
)

; Constructor calls
(new_expression
  constructor: (identifier) @ref.new.class
  arguments: (arguments)? @ref.new.args
)

; Property access
(member_expression
  object: (identifier) @ref.member.object
  property: [
    (property_identifier) @ref.member.property
    (private_property_identifier) @ref.member.private
  ]
)

; Computed property access
(subscript_expression
  object: (identifier) @ref.subscript.object
  index: (_) @ref.subscript.index
)

; Variable references
(identifier) @ref.identifier

; Assignment targets (creates binding if not exists for simple assignment)
; Assignment operations
(assignment_expression
  left: (identifier) @ref.assign.target
  right: (_) @ref.assign.value
)

(update_expression
  argument: (identifier) @ref.update.target
)

; JSX references
(jsx_opening_element
  (identifier) @ref.jsx.component
)

(jsx_self_closing_element
  (identifier) @ref.jsx.component
)

; Type references (for TypeScript)
(type_identifier) @ref.type

; Super references
(super) @ref.super

; This references
(this) @ref.this

;; ==============================================================================
;; TYPE ANNOTATIONS (TypeScript specific)
;; ==============================================================================

; Type annotations on variables
(variable_declarator
  name: (identifier)
  type: (type_annotation (_) @type.annotation)
)

; Function return types
(function_declaration
  return_type: (type_annotation (_) @type.return)
)

(arrow_function
  return_type: (type_annotation (_) @type.return)
)

(method_definition
  return_type: (type_annotation (_) @type.return)
)

; Parameter types
(formal_parameters
  (required_parameter
    pattern: (identifier) @type.param.name
    type: (type_annotation (_) @type.param.annotation)
  )
)

; Interface definitions
(interface_declaration
  name: (type_identifier) @def.interface.name
  body: (interface_body) @def.interface.body
) @def.interface

; Type alias definitions
(type_alias_declaration
  name: (type_identifier) @def.type_alias.name
  value: (_) @def.type_alias.value
) @def.type_alias

; Enum definitions
(enum_declaration
  name: (identifier) @def.enum.name
  body: (enum_body) @def.enum.body
) @def.enum

;; ==============================================================================
;; SPECIAL PATTERNS
;; ==============================================================================

; Template literal references
(template_substitution
  (identifier) @ref.template
)

; Spread references
(spread_element
  (identifier) @ref.spread
)

; Object shorthand (both definition and reference)
(object
  (shorthand_property_identifier) @ref.shorthand
)

; Break/continue with labels
(break_statement
  label: (statement_identifier) @ref.break_label
)

(continue_statement
  label: (statement_identifier) @ref.continue_label
)

; Yield expressions
(yield_expression
  (_) @ref.yield
)

; Await expressions
(await_expression
  (identifier) @ref.await
)