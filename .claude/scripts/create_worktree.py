#!/usr/bin/env python3
"""
Worktree Creator for ariadne
Generated by worktree-script-generator

Creates isolated worktrees with WezTerm + Claude Code's built-in sandbox.
Each worktree gets a sandboxed Claude session in a WezTerm tab.

Flow:
1. Create git worktree
2. Copy state files (.env, etc.)
3. Run build command
4. Open WezTerm tab with Claude (sandbox enabled via --settings flag)
"""
# /// script
# requires-python = ">=3.11"
# ///

import argparse
import shutil
import subprocess
import sys
from pathlib import Path

# Import shared worktree infrastructure (in same directory)
from worktree_state import add_worktree
from worktree_sandbox import claude_available, get_claude_command
from worktree_wezterm import ensure_wezterm_running, create_tab

# === PROJECT-SPECIFIC CONFIGURATION ===
# The worktree-script-generator agent replaces these placeholders:
#   __PROJECT_NAME__ → detected project name (e.g., "ariadne")
#   __STATE_FILES__ → Python list (e.g., [".env", ".env.local"])
#   __BUILD_COMMAND__ → build command (e.g., "pnpm install")

PROJECT_NAME = "ariadne"
STATE_FILES = [".auto-claude/.env"]
BUILD_COMMAND = "pnpm install && pnpm run build"

# === IMPLEMENTATION ===


def main():
    parser = argparse.ArgumentParser(
        description="Create a worktree for parallel development (WezTerm + Claude sandbox)",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python create_worktree.py fix-auth-bug
  python create_worktree.py feat-dark-mode --base develop
  python create_worktree.py JIRA-1234 --task "Implement user profile page"
""",
    )
    parser.add_argument("task_name", help="Name for the task/branch")
    parser.add_argument("-b", "--base", help="Base branch (default: current)")
    parser.add_argument(
        "-t", "--task",
        help="Task description to pass to Claude agent",
    )
    args = parser.parse_args()

    # Validate prerequisites
    if not ensure_wezterm_running():
        print("Error: WezTerm CLI not available or failed to start", file=sys.stderr)
        sys.exit(1)

    if not claude_available():
        print("Error: Claude CLI is not available", file=sys.stderr)
        print("  Install Claude Code and try again.", file=sys.stderr)
        sys.exit(1)

    # Get repo root
    repo_root = Path(subprocess.run(
        ["git", "rev-parse", "--show-toplevel"],
        capture_output=True, text=True, check=True
    ).stdout.strip())

    # Sanitize task name
    safe_name = args.task_name.replace("/", "-").replace(" ", "-").lower()
    worktree_path = repo_root / ".worktrees" / safe_name
    branch_name = f"worktree/{safe_name}"

    if worktree_path.exists():
        print(f"Error: {worktree_path} already exists", file=sys.stderr)
        sys.exit(1)

    # Get base branch
    base = args.base or subprocess.run(
        ["git", "rev-parse", "--abbrev-ref", "HEAD"],
        capture_output=True, text=True, check=True
    ).stdout.strip()

    # Create worktree
    print(f"Creating worktree: {safe_name} (from {base})")
    (repo_root / ".worktrees").mkdir(exist_ok=True)
    subprocess.run(
        ["git", "worktree", "add", "-b", branch_name, str(worktree_path), base],
        check=True, cwd=repo_root
    )

    # Copy state files
    for f in STATE_FILES:
        src = repo_root / f
        if src.exists():
            dest = worktree_path / f
            dest.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(src, dest)
            print(f"  Copied: {f}")

    # Run build command
    if BUILD_COMMAND:
        print(f"  Running: {BUILD_COMMAND}")
        subprocess.run(BUILD_COMMAND, shell=True, cwd=worktree_path, check=True)

    # Build claude command (pass task as positional arg if provided)
    exec_cmd = get_claude_command(task=args.task)
    tab_title = f"wt: {safe_name}"

    # Create WezTerm tab in project-specific workspace
    print("  Opening WezTerm tab...")
    success, pane_id, msg = create_tab(
        title=tab_title,
        cwd=worktree_path,
        command=exec_cmd,
        workspace=PROJECT_NAME,  # Groups all worktrees for this project
    )
    if not success:
        print(f"  Warning: {msg}", file=sys.stderr)
        pane_id = None

    # Update state file
    add_worktree(
        repo_root,
        name=safe_name,
        worktree_path=str(worktree_path.relative_to(repo_root)),
        branch=branch_name,
        pane_id=pane_id,
    )

    # Print summary
    print(f"\nWorktree ready at: {worktree_path}")
    print(f"Branch: {branch_name}")
    print(f"Sandbox: enabled (Claude Code built-in)")
    if pane_id:
        print(f"WezTerm tab: {tab_title} (pane {pane_id})")
    if args.task:
        print(f"Task: {args.task}")


if __name__ == "__main__":
    main()
